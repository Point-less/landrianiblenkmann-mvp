{% extends "base.html" %}
{% load workflow_extras %}
{% block title %}Documental Validations | {{ block.super }}{% endblock %}
{% block content %}
<div class="page-header">
    <h2>Documental Validations</h2>
</div>
<div class="card">
    <table>
        <tr><th>Property</th><th>Summary</th><th>Documents</th><th>Status</th><th>Transitions</th><th class="actions-column">Actions</th></tr>
        {% for validation in provider_validations %}
            <tr>
                <td>
                    <div class="table-title">{{ validation.opportunity.source_intention.property }}</div>
                    <div class="table-subtext">Owner: {{ validation.opportunity.source_intention.owner }}</div>
                </td>
                <td>
                    {% with summary=validation.document_status_summary %}
                        <div class="table-subtext">
                            {{ summary.accepted }}/{{ summary.required_total }} accepted Â·
                            {{ summary.pending }} pending Â·
                            {{ summary.rejected }} rejected Â·
                            {{ summary.missing }} missing
                        </div>
                        {% if summary.additional %}
                            <div class="table-subtext">Additional docs: {{ summary.additional }}</div>
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    <ul class="document-list">
                        {% for requirement in validation.required_documents_status %}
                            <li>
                                <strong>{{ requirement.label }}</strong>
                                {% if requirement.document %}
                                    <span class="pill status-{{ requirement.document.status }}">{{ requirement.document.get_status_display }}</span>
                                    <a href="{{ requirement.document.document.url }}" download>Download</a>
                                    {% if validation.state == 'presented' %}
                                        <a href="{% url 'validation-document-review' requirement.document.id %}?next={{ current_url|urlencode }}">Review</a>
                                    {% endif %}
                                {% else %}
                                    <span class="pill status-missing">Missing</span>
                                {% endif %}
                                {% if validation.state == 'preparing' or validation.state == 'presented' %}
                                    <a href="{% url 'validation-document-upload' validation.id %}?document_type={{ requirement.code }}&next={{ current_url|urlencode }}">Upload</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                        {% if validation.additional_documents %}
                            {% for doc in validation.additional_documents %}
                                <li>
                                    {{ doc.name }}
                                    <span class="pill status-{{ doc.status }}">{{ doc.get_status_display }}</span>
                                    <a href="{{ doc.document.url }}" download>Download</a>
                                    {% if validation.state == 'presented' %}
                                        <a href="{% url 'validation-document-review' doc.id %}?next={{ current_url|urlencode }}">Review</a>
                                    {% endif %}
                                    {% if validation.state == 'preparing' or validation.state == 'presented' %}
                                        <a href="{% url 'validation-document-upload' validation.id %}?document_type={{ doc.document_type }}&next={{ current_url|urlencode }}">Replace</a>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </td>
                <td>
                    <span class="pill">{{ validation.get_state_display }}</span>
                </td>
                <td class="latest-activity">
                    <div class="transition-text">
                        {% with latest=validation.state_transitions.all|first %}
                            {% if latest %}
                                <span>{{ latest.from_state|default:'â€”' }} â†’ {{ latest.to_state }}</span>
                                <small class="muted">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <a class="history-link" href="{% url 'transition-history' 'opportunities' 'validation' validation.id %}?next={{ current_url|urlencode }}" title="View history">â†º</a>
                </td>
                <td class="actions-column">
                    <a class="icon-button" data-icon="ðŸ”" href="{% url 'validation-detail' validation.id %}?next={{ current_url|urlencode }}" title="View validation detail">
                        <span class="sr-only">View details</span>
                    </a>
                    {% if validation|can_transition:'present' %}
                        <a class="icon-button" data-icon="ðŸ“¤" href="{% url 'validation-present' validation.id %}?next={{ current_url|urlencode }}" title="Present validation">
                            <span class="sr-only">Present validation</span>
                        </a>
                    {% endif %}
                    {% if validation|can_transition:'accept' %}
                        <a class="icon-button" data-icon="âœ…" href="{% url 'validation-accept' validation.id %}?next={{ current_url|urlencode }}" title="Accept validation">
                            <span class="sr-only">Accept validation</span>
                        </a>
                    {% endif %}
                    {% if validation|can_transition:'revoke' %}
                        <a class="icon-button" data-icon="â†º" data-variant="warning" href="{% url 'validation-reject' validation.id %}?next={{ current_url|urlencode }}" title="Revoke to preparing">
                            <span class="sr-only">Revoke validation to preparing</span>
                        </a>
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="6">No validations yet.</td></tr>
        {% endfor %}
    </table>
</div>
{% endblock %}
