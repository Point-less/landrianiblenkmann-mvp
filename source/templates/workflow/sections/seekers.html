{% extends "base.html" %}
{% load workflow_extras %}
{% block title %}Seekers | {{ block.super }}{% endblock %}
{% block content %}
{% url 'workflow-dashboard-section' 'seekers' as seekers_dashboard_url %}
<section>
    <h2>Seeker Intentions</h2>
    <div class="card">
        <table>
            <tr><th>Contact</th><th>Budget</th><th>Latest Activity</th><th>Actions</th></tr>
            {% for intention in seeker_intentions %}
                <tr>
                    <td>{{ intention.contact }}</td>
                    <td>
                        {% if intention.budget_min or intention.budget_max %}
                            {{ intention.budget_min }} - {{ intention.budget_max }} {{ intention.currency }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% with latest=intention.state_transitions.all|first %}
                            {% if latest %}
                                {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                                <small style="color:#6b7280;">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                        <a class="history-link" href="{% url 'transition-history' 'intentions' 'saleseekerintention' intention.id %}">↺</a>
                    </td>
                    <td class="actions">
                        {% if intention|can_transition:'activate_search' %}
                            <a href="{% url 'seeker-activate' intention.id %}?next={{ seekers_dashboard_url }}">Activate</a>
                        {% endif %}
                        {% if intention|can_transition:'sign_mandate' %}
                            <a href="{% url 'seeker-mandate' intention.id %}?next={{ seekers_dashboard_url }}">Mandate</a>
                        {% endif %}
                        {% if intention.can_create_opportunity %}
                            <a href="{% url 'seeker-create-opportunity' intention.id %}?next={{ seekers_dashboard_url }}">Create opportunity</a>
                        {% endif %}
                        {% if intention|can_transition:'abandon' %}
                            <a href="{% url 'seeker-abandon' intention.id %}?next={{ seekers_dashboard_url }}">Abandon</a>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="4">No seeker intentions.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>
<section>
    <h2>Seeker Opportunities</h2>
    <div class="card">
        <table>
            <tr><th>Contact</th><th>State</th><th>Latest Activity</th></tr>
            {% for opportunity in seeker_opportunities %}
                <tr>
                    <td>{{ opportunity.source_intention.contact }}</td>
                    <td>{{ opportunity.get_state_display }}</td>
                    <td>
                        {% with latest=opportunity.state_transitions.all|first %}
                            {% if latest %}
                                {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                                <small style="color:#6b7280;">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                        <a class="history-link" href="{% url 'transition-history' 'opportunities' 'seekeropportunity' opportunity.id %}">↺</a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="3">No seeker opportunities.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>
{% endblock %}
