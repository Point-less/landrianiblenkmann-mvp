{% extends "base.html" %}

{% block title %}Dashboard | {{ block.super }}{% endblock %}

{% block content %}
<section id="core-section" class="workflow-section">
    <h2>Core</h2>
    <div class="card">
        <h3>Agents</h3>
        <table>
            <tr><th>Name</th><th>Email</th></tr>
            {% for agent in agents %}
                <tr><td>{{ agent }}</td><td>{{ agent.email }}</td></tr>
            {% empty %}
                <tr><td colspan="2">No agents yet.</td></tr>
            {% endfor %}
        </table>
    </div>
    <div class="card">
        <h3>Contacts</h3>
        <table>
            <tr><th>Name</th><th>Email</th></tr>
            {% for contact in contacts %}
                <tr><td>{{ contact }}</td><td>{{ contact.email }}</td></tr>
            {% empty %}
                <tr><td colspan="2">No contacts yet.</td></tr>
            {% endfor %}
        </table>
    </div>
    <div class="card">
        <h3>Properties</h3>
        <table>
            <tr><th>Name</th><th>Reference</th></tr>
            {% for property in properties %}
                <tr><td>{{ property.name }}</td><td>{{ property.reference_code }}</td></tr>
            {% empty %}
                <tr><td colspan="2">No properties yet.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>

<section id="providers-section" class="workflow-section">
    <h2>Providers</h2>
    <div class="card">
        <h3>Provider Intentions</h3>
        <table>
            <tr><th>Property</th><th>Owner</th><th>State</th><th>Activity</th><th>Actions</th></tr>
            {% for intention in provider_intentions %}
                <tr>
                    <td>{{ intention.property }}</td>
                    <td>{{ intention.owner }}</td>
                    <td>{{ intention.get_state_display }}</td>
                    <td>
                        {% with latest=intention.state_transitions.all|first %}
                            {% if latest %}
                                {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                                <small style="color:#6b7280;">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                        <a class="history-link" title="View history" href="{% url 'transition-history' 'intentions' 'saleproviderintention' intention.id %}">↺</a>
                    </td>
                    <td class="actions">
                        <a href="{% url 'provider-deliver-valuation' intention.id %}">Deliver valuation</a>
                        <a href="{% url 'provider-start-contract' intention.id %}">Start contract</a>
                        <a href="{% url 'provider-promote' intention.id %}">Promote</a>
                        <a href="{% url 'provider-withdraw' intention.id %}">Withdraw</a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="5">No provider intentions.</td></tr>
            {% endfor %}
        </table>
    </div>
    <div class="card">
        <h3>Provider Opportunities &amp; Validations</h3>
        <table>
            <tr><th>Property</th><th>State</th><th>Validations</th><th>Documents</th><th>Activity</th></tr>
            {% for opportunity in provider_opportunities %}
                {% with validation=opportunity.validations.first %}
                <tr>
                    <td>{{ opportunity.source_intention.property }}</td>
                    <td>{{ opportunity.get_state_display }}</td>
                    <td>
                        {% if validation %}
                            <div class="pill">{{ validation.get_state_display }}</div><br>
                            <div class="actions" style="margin-top:0.3rem;">
                                <a href="{% url 'provider-opportunity-validate' opportunity.id %}">Start validation</a>
                                <a href="{% url 'validation-present' validation.id %}">Present</a>
                                <a href="{% url 'validation-accept' validation.id %}">Accept</a>
                                <a href="{% url 'validation-reject' validation.id %}">Reject</a>
                                <a href="{% url 'validation-document-upload' validation.id %}">Upload doc</a>
                            </div>
                        {% else %}
                            No validation yet.
                        {% endif %}
                    </td>
                    <td>
                        {% if validation %}
                            <ul style="padding-left:1rem;margin:0;">
                                {% for doc in validation.documents.all %}
                                    <li>
                                        {{ doc.name }}
                                        <span class="pill status-{{ doc.status }}">{{ doc.get_status_display }}</span>
                                        {% if doc.status == 'pending' %}
                                            <a href="{% url 'validation-document-review' doc.id %}">Review</a>
                                        {% endif %}
                                        {% if doc.reviewer_comment %}<br><small>{{ doc.reviewer_comment }}</small>{% endif %}
                                    </li>
                                {% empty %}
                                    <li>No documents yet.</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% with latest=opportunity.state_transitions.all|first %}
                            {% if latest %}
                                {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                                <small style="color:#6b7280;">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                        <a class="history-link" title="View history" href="{% url 'transition-history' 'opportunities' 'provideropportunity' opportunity.id %}">↺</a>
                    </td>
                </tr>
                {% endwith %}
            {% empty %}
                <tr><td colspan="5">No provider opportunities.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>

<section id="seekers-section" class="workflow-section">
    <h2>Seekers</h2>
    <div class="card">
        <h3>Seeker Intentions</h3>
        <table>
            <tr><th>Contact</th><th>State</th><th>Budget</th><th>Activity</th><th>Actions</th></tr>
            {% for intention in seeker_intentions %}
                <tr>
                    <td>{{ intention.contact }}</td>
                    <td>{{ intention.get_state_display }}</td>
                    <td>
                        {% if intention.budget_min or intention.budget_max %}
                            {{ intention.budget_min }} - {{ intention.budget_max }} {{ intention.currency }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% with latest=intention.state_transitions.all|first %}
                            {% if latest %}
                                {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                                <small style="color:#6b7280;">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                        <a class="history-link" title="View history" href="{% url 'transition-history' 'intentions' 'saleseekerintention' intention.id %}">↺</a>
                    </td>
                    <td class="actions">
                        <a href="{% url 'seeker-activate' intention.id %}">Activate</a>
                        <a href="{% url 'seeker-mandate' intention.id %}">Mandate</a>
                        <a href="{% url 'seeker-create-opportunity' intention.id %}">Create opportunity</a>
                        <a href="{% url 'seeker-abandon' intention.id %}">Abandon</a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="5">No seeker intentions.</td></tr>
            {% endfor %}
        </table>
    </div>
    <div class="card">
        <h3>Seeker Opportunities</h3>
        <table>
            <tr><th>Contact</th><th>State</th><th>Activity</th></tr>
            {% for opportunity in seeker_opportunities %}
                <tr>
                    <td>{{ opportunity.source_intention.contact }}</td>
                    <td>{{ opportunity.get_state_display }}</td>
                    <td>
                        {% with latest=opportunity.state_transitions.all|first %}
                            {% if latest %}
                                {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                                <small style="color:#6b7280;">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                        <a class="history-link" title="View history" href="{% url 'transition-history' 'opportunities' 'seekeropportunity' opportunity.id %}">↺</a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="3">No seeker opportunities.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>

<section id="operations-section" class="workflow-section">
    <h2>Operations</h2>
    <div class="card">
        <table>
            <tr><th>Provider</th><th>Seeker</th><th>State</th><th>Activity</th><th>Actions</th></tr>
            {% for operation in operations %}
                <tr>
                    <td>{{ operation.provider_opportunity }}</td>
                    <td>{{ operation.seeker_opportunity }}</td>
                    <td>{{ operation.get_state_display }}</td>
                    <td>
                        <ul class="timeline">
                            {% for log in operation.state_transitions.all|slice:":3" %}
                                <li>{{ log.from_state|default:'—' }} → {{ log.to_state }}<time>{{ log.occurred_at|date:"m/d H:i" }}</time></li>
                            {% empty %}
                                <li>No transitions yet.</li>
                            {% endfor %}
                        </ul>
                        <a class="history-link" title="View history" href="{% url 'transition-history' 'opportunities' 'operation' operation.id %}">↺</a>
                    </td>
                    <td class="actions">
                        <a href="{% url 'operation-reinforce' operation.id %}">Reinforce</a>
                        <a href="{% url 'operation-close' operation.id %}">Close</a>
                        <a href="{% url 'operation-lose' operation.id %}">Lose</a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="5">No operations.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>

<section id="integrations-section" class="workflow-section">
    <h2>Integrations</h2>
    <div class="card">
        <h3>Tokkobroker</h3>
        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
            <form method="post" action="{% url 'integration-tokko-sync-now' %}">
                {% csrf_token %}
                <button type="submit">Sync immediately</button>
            </form>
            <form method="post" action="{% url 'integration-tokko-sync-enqueue' %}">
                {% csrf_token %}
                <button type="submit">Enqueue background sync</button>
            </form>
            <form method="post" action="{% url 'integration-tokko-clear' %}" onsubmit="return confirm('Clear all Tokkobroker properties?');">
                {% csrf_token %}
                <button type="submit" style="background:#dc2626;">Clear properties</button>
            </form>
        </div>
        <h4>Recent Imports</h4>
        <table>
            <tr><th>Tokko ID</th><th>Ref</th><th>Address</th><th>Imported</th></tr>
            {% for property in tokko_properties %}
                <tr>
                    <td>{{ property.tokko_id }}</td>
                    <td>{{ property.ref_code }}</td>
                    <td>{{ property.address }}</td>
                    <td>{{ property.created_at|date:"Y-m-d H:i" }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="4">No Tokkobroker data yet.</td></tr>
            {% endfor %}
        </table>
    </div>
</section>

{% comment %}Transitions now live inside Operations section{% endcomment %}
{% endblock %}
