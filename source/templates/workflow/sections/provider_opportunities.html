{% extends "base.html" %}
{% load workflow_extras %}
{% block title %}Provider Opportunities | {{ block.super }}{% endblock %}
{% block content %}
<div class="page-header">
    <h2>Provider Opportunities</h2>
</div>
<div class="card">
    <table>
        <tr><th>Property</th><th>Status</th><th>Transitions</th><th class="actions-column">Actions</th></tr>
        {% for opportunity in provider_opportunities %}
            <tr>
                <td>
                    <div class="table-title">{{ opportunity.source_intention.property }}</div>
                    <div class="table-subtext">Owner: {{ opportunity.source_intention.owner }}</div>
                    {% if opportunity.tokkobroker_property %}
                        <div class="table-subtext">
                            Tokkobroker: {{ opportunity.tokkobroker_property.ref_code }} (ID {{ opportunity.tokkobroker_property.tokko_id }})
                        </div>
                    {% endif %}
                </td>
                <td>
                    <span class="pill">{{ opportunity.get_state_display }}</span>
                    <div class="table-subtext">{{ opportunity.get_listing_kind_display }}</div>
                </td>
                <td class="latest-activity">
                    {% url 'transition-history' 'opportunities' 'provideropportunity' opportunity.id as history_url %}
                    {% include "workflow/partials/latest_transition.html" with transitions=opportunity.state_transitions.all history_url=history_url next_url=current_url %}
                </td>
                <td class="actions-column">
                    {% with validation=opportunity.validations.first %}
                        {% if validation %}
                            <a class="icon-button" data-icon="ðŸ“„" href="{% url 'validation-detail' validation.id %}?next={{ current_url|urlencode }}" title="Open validation">
                                <span class="sr-only">Open validation</span>
                            </a>
                        {% endif %}
                    {% endwith %}
                    <a class="icon-button" data-icon="ðŸ—‚" href="{% url 'marketing-package-history' opportunity.id %}?next={{ current_url|urlencode }}" title="Marketing packages & revisions">
                        <span class="sr-only">Marketing packages</span>
                    </a>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="4">No provider opportunities.</td></tr>
        {% endfor %}
    </table>
</div>
{% endblock %}
