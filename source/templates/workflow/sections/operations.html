{% extends "base.html" %}
{% load workflow_extras %}
{% block title %}Operations | {{ block.super }}{% endblock %}
{% block content %}
<div class="page-header">
    <h2>Operations</h2>
    {% if page_new_url %}
        <a class="btn" href="{{ page_new_url }}?next={{ current_url|urlencode }}">New</a>
    {% endif %}
</div>
<div class="card">
    <table>
        <tr><th>Provider</th><th>Seeker</th><th>Status</th><th>Latest Activity</th><th>Actions</th></tr>
        {% for operation in operations %}
            <tr>
                <td>
                    <div class="table-title">{{ operation.provider_opportunity }}</div>
                    <div class="table-subtext">{{ operation.provider_opportunity.source_intention.owner }}</div>
                </td>
                <td>
                    <div class="table-title">{{ operation.seeker_opportunity }}</div>
                    <div class="table-subtext">{{ operation.seeker_opportunity.source_intention.contact }}</div>
                </td>
                <td>
                    <span class="pill">{{ operation.get_state_display }}</span>
                    <div class="table-subtext">Currency: {{ operation.currency|default:"—" }}</div>
                </td>
                <td>
                    {% with latest=operation.state_transitions.all|first %}
                        {% if latest %}
                            {{ latest.from_state|default:'—' }} → {{ latest.to_state }}
                            <small class="muted">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                        {% else %}
                            <span>No transitions yet.</span>
                        {% endif %}
                    {% endwith %}
                    <a class="history-link" href="{% url 'transition-history' 'opportunities' 'operation' operation.id %}?next={{ current_url|urlencode }}">↺</a>
                </td>
                <td class="actions">
                    {% if operation|can_transition:'reinforce' %}
                        <a href="{% url 'operation-reinforce' operation.id %}?next={{ current_url|urlencode }}">Reinforce</a>
                    {% endif %}
                    {% if operation|can_transition:'close' %}
                        <a href="{% url 'operation-close' operation.id %}?next={{ current_url|urlencode }}">Close</a>
                    {% endif %}
                    {% if operation|can_transition:'lose' %}
                        <a href="{% url 'operation-lose' operation.id %}?next={{ current_url|urlencode }}">Lose</a>
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="5">No operations.</td></tr>
        {% endfor %}
    </table>
</div>
{% endblock %}
