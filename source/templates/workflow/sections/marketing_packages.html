{% extends "base.html" %}
{% load workflow_extras %}
{% block title %}Marketing Packages | {{ block.super }}{% endblock %}
{% block content %}
<div class="page-header">
    <h2>Marketing Packages</h2>
</div>
<div class="card">
    <table>
        <tr><th>Property</th><th>Details</th><th>Status</th><th>Transitions</th><th class="actions-column">Actions</th></tr>
        {% for package in marketing_packages %}
            <tr>
                <td>
                    <div class="table-title">{{ package.opportunity.source_intention.property }}</div>
                    <div class="table-subtext">Owner: {{ package.opportunity.source_intention.owner }}</div>
                </td>
                <td>
                    <div class="table-title">{{ package.headline|default:"Unnamed package" }}</div>
                    {% if package.description %}
                        <div class="table-subtext">{{ package.description }}</div>
                    {% endif %}
                    {% if package.features %}
                        <div class="table-subtext">Features: {{ package.features }}</div>
                    {% endif %}
                </td>
                <td>
                    <span class="pill">{{ package.get_state_display }}</span>
                    {% if package.price %}
                        <div class="table-subtext">{{ package.price }} {{ package.currency }}</div>
                    {% endif %}
                </td>
                <td class="latest-activity">
                    {% url 'transition-history' 'opportunities' 'marketingpackage' package.id as history_url %}
                    {% include "workflow/partials/latest_transition.html" with transitions=package.state_transitions.all history_url=history_url next_url=current_url %}
                </td>
                <td class="actions-column">
                    <a class="icon-button" data-icon="✏" href="{% url 'marketing-package-edit' package.id %}?next={{ current_url|urlencode }}" title="Edit package">
                        <span class="sr-only">Edit marketing package</span>
                    </a>
                    {% if package|can_transition:'activate' %}
                        <a class="icon-button" data-icon="▶" href="{% url 'marketing-package-activate' package.id %}?next={{ current_url|urlencode }}" title="Activate package">
                            <span class="sr-only">Activate marketing package</span>
                        </a>
                    {% endif %}
                    {% if package|can_transition:'pause' %}
                        <a class="icon-button" data-icon="⏸" data-variant="warning" href="{% url 'marketing-package-pause' package.id %}?next={{ current_url|urlencode }}" title="Pause package">
                            <span class="sr-only">Pause marketing package</span>
                        </a>
                    {% endif %}
                    {% if package|can_transition:'publish' %}
                        <a class="icon-button" data-icon="⏯" href="{% url 'marketing-package-release' package.id %}?next={{ current_url|urlencode }}" title="Resume package">
                            <span class="sr-only">Resume marketing package</span>
                        </a>
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="5">No marketing packages yet.</td></tr>
        {% endfor %}
    </table>
</div>

{% if archived_marketing_packages %}
<div class="card">
    <h3>Past Marketing Packages</h3>
    <table>
        <tr><th>Property</th><th>Details</th><th>Status</th><th class="actions-column">History</th></tr>
        {% for package in archived_marketing_packages %}
            <tr>
                <td>
                    <div class="table-title">{{ package.opportunity.source_intention.property }}</div>
                    <div class="table-subtext">Owner: {{ package.opportunity.source_intention.owner }}</div>
                </td>
                <td>
                    <div class="table-title">{{ package.headline|default:"Unnamed package" }}</div>
                    {% if package.description %}
                        <div class="table-subtext">{{ package.description }}</div>
                    {% endif %}
                </td>
                <td><span class="pill">{{ package.get_state_display }}</span></td>
                <td class="actions-column">
                    {% url 'transition-history' 'opportunities' 'marketingpackage' package.id as history_url %}
                    <a class="icon-button" data-icon="↺" href="{{ history_url }}?next={{ current_url|urlencode }}" title="View history">
                        <span class="sr-only">View history</span>
                    </a>
                </td>
            </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

{% if marketing_opportunities_without_packages %}
<div class="card">
    <h3>Opportunities without packages</h3>
    <table>
        <tr><th>Property</th><th>Status</th><th>Transitions</th><th class="actions-column">Actions</th></tr>
        {% for opportunity in marketing_opportunities_without_packages %}
            <tr>
                <td>
                    <div class="table-title">{{ opportunity.source_intention.property }}</div>
                    <div class="table-subtext">Owner: {{ opportunity.source_intention.owner }}</div>
                </td>
                <td><span class="pill">{{ opportunity.get_state_display }}</span></td>
                <td class="latest-activity">
                    <div class="transition-text">
                        {% with latest=opportunity.state_transitions.all|first %}
                            {% if latest %}
                                <span>{{ latest.from_state|default:'—' }} → {{ latest.to_state }}</span>
                                <small class="muted">{{ latest.occurred_at|date:"m/d H:i" }}</small>
                            {% else %}
                                <span>No transitions yet.</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <a class="history-link" href="{% url 'transition-history' 'opportunities' 'provideropportunity' opportunity.id %}?next={{ current_url|urlencode }}" title="View history">↺</a>
                </td>
                <td class="actions-column">
                    <a class="icon-button" data-icon="➕" href="{% url 'marketing-package-create' opportunity.id %}?next={{ current_url|urlencode }}" title="Create marketing package">
                        <span class="sr-only">Create marketing package</span>
                    </a>
                </td>
            </tr>
        {% endfor %}
    </table>
</div>
{% endif %}
{% endblock %}
